name: Test Cloud Services

on:
  workflow_call:
    inputs:
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test Cloud Services API

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        submodules: true

    - name: Install Python dependencies
      uses: ./.github/actions/install-python-requirements
      with:
        requirements_path: requirements.txt
        working_directory: cloud-services
        python_version: ${{ inputs.python_version }}

    - name: Install test dependencies
      shell: bash
      working-directory: cloud-services
      run: |
        pip install pytest pytest-asyncio httpx

    - name: Run API tests
      shell: bash
      working-directory: cloud-services
      run: |
        pytest tests/ -v --tb=short

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results-cloud-services
        path: cloud-services/junit/
        if-no-files-found: ignore
